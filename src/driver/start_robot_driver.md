# Robot Driver å¯åŠ¨æµç¨‹è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿° `robot_driver` èŠ‚ç‚¹çš„å¯åŠ¨æµç¨‹è®¾è®¡ã€‚å¯åŠ¨æµç¨‹é‡‡ç”¨**ä¸¤é˜¶æ®µ**è®¾è®¡ï¼Œç¡®ä¿èŠ‚ç‚¹åœ¨æ‰€æœ‰åˆå§‹åŒ–å®Œæˆåæ‰è¿›å…¥å¯å“åº”çŠ¶æ€ã€‚

---

## å¯åŠ¨æµç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     RobotDriverNode å¯åŠ¨                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         ç¬¬ä¸€é˜¶æ®µï¼ˆBaseï¼‰ï¼šåŸºç¡€å¯åŠ¨                       â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  ã€åŒæ­¥ä»»åŠ¡ã€‘                                           â”‚   â”‚
â”‚  â”‚  â€¢ åˆ›å»º ROS Node                                        â”‚   â”‚
â”‚  â”‚  â€¢ è¯»å–å‚æ•°é…ç½®                                         â”‚   â”‚
â”‚  â”‚  â€¢ åˆ›å»º HardwareCommanderï¼ˆä¸è¿æ¥ï¼‰                     â”‚   â”‚
â”‚  â”‚  â€¢ åˆ›å»ºå„ç§ Manager                                     â”‚   â”‚
â”‚  â”‚  â€¢ åˆ›å»ºæœåŠ¡/Action Server                               â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  ã€å¼‚æ­¥ä»»åŠ¡ã€‘                                           â”‚   â”‚
â”‚  â”‚  â€¢ CAN æ¥å£å‡†å¤‡                                         â”‚   â”‚
â”‚  â”‚  â€¢ ç¡¬ä»¶è¿æ¥ï¼ˆ_robot èµ‹å€¼ï¼‰                              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  âœ… å®Œæˆåï¼šå†…éƒ¨å¯ç”¨ action/service                     â”‚   â”‚
â”‚  â”‚            å¤–éƒ¨è¯·æ±‚ä»æ‹’ç»ï¼ˆé˜²æ­¢ä¸ç¬¬äºŒé˜¶æ®µå†²çªï¼‰          â”‚   â”‚
â”‚  â”‚  ğŸ“ æ—¥å¿—ï¼š[robot_start] åŸºç¡€å¯åŠ¨å®Œæˆ                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         ç¬¬äºŒé˜¶æ®µï¼ˆExtï¼‰ï¼šæ‰©å±•å¯åŠ¨                        â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  ã€å¼‚æ­¥ä»»åŠ¡ã€‘ï¼ˆé€šè¿‡ action/service è°ƒç”¨ï¼‰               â”‚   â”‚
â”‚  â”‚  â€¢ å®‰å…¨ä½å§¿å¤ä½ï¼ˆé€šè¿‡ action/jointï¼‰                    â”‚   â”‚
â”‚  â”‚  â€¢ é›¶é‡åŠ›æ¨¡å¼å¼€å¯ï¼ˆé€šè¿‡ service/zero_gravityï¼‰          â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  âœ… å®Œæˆåï¼šå¤–éƒ¨è¯·æ±‚å¯æ¥å—                              â”‚   â”‚
â”‚  â”‚  ğŸ“ æ—¥å¿—ï¼š[robot_start] å¯åŠ¨ç»“æŸ                        â”‚   â”‚
â”‚  â”‚  â†’ shell è„šæœ¬æ‰“å°å¯åŠ¨æˆåŠŸ                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  âŒ ä»»æ„é˜¶æ®µä»»æ„ä»»åŠ¡å¤±è´¥ â†’ ERROR çŠ¶æ€ï¼Œå¯åŠ¨å¤±è´¥              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## çŠ¶æ€å®šä¹‰

```python
class RobotState(Enum):
    INITIALIZING = "initializing"    # ç¬¬ä¸€é˜¶æ®µï¼šåŒæ­¥ä»»åŠ¡æ‰§è¡Œä¸­
    CONNECTING = "connecting"        # ç¬¬ä¸€é˜¶æ®µï¼šå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œä¸­
    CALIBRATING = "calibrating"      # ç¬¬äºŒé˜¶æ®µï¼šæ‰©å±•ä»»åŠ¡æ‰§è¡Œä¸­
    READY = "ready"                  # å®Œå…¨å°±ç»ªï¼Œå¯æ¥å—å¤–éƒ¨è¯·æ±‚
    SHUTTING_DOWN = "shutting_down"  # æ­£åœ¨å…³é—­
    ERROR = "error"                  # é”™è¯¯çŠ¶æ€ï¼Œå¯åŠ¨å¤±è´¥
```

### çŠ¶æ€æµè½¬å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ INITIALIZING â”‚  ç¬¬ä¸€é˜¶æ®µåŒæ­¥ä»»åŠ¡
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ æˆåŠŸ
                           â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  CONNECTING  â”‚  ç¬¬ä¸€é˜¶æ®µå¼‚æ­¥ä»»åŠ¡
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ æˆåŠŸ
                           â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CALIBRATING  â”‚  ç¬¬äºŒé˜¶æ®µï¼ˆå®‰å…¨ä½å§¿+é›¶é‡åŠ›ï¼‰
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ æˆåŠŸ
                           â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    READY     â”‚  å®Œå…¨å°±ç»ª
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ shutdown è¯·æ±‚
                           â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚SHUTTING_DOWN â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        ä»»æ„é˜¶æ®µå¤±è´¥
              â”‚
              â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    ERROR     â”‚  å¯åŠ¨å¤±è´¥ï¼Œéœ€é‡å¯
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¤–éƒ¨è¯·æ±‚å¤„ç†ç­–ç•¥

| çŠ¶æ€ | å¤–éƒ¨è¯·æ±‚å¤„ç† | å†…éƒ¨è°ƒç”¨ |
|------|-------------|----------|
| INITIALIZING | æ‹’ç» | ä¸å¯ç”¨ |
| CONNECTING | æ‹’ç» | ä¸å¯ç”¨ |
| CALIBRATING | æ‹’ç»ï¼ˆé˜²æ­¢å†²çªï¼‰ | å¯ç”¨ï¼ˆç¬¬äºŒé˜¶æ®µé€šè¿‡å†…éƒ¨è°ƒç”¨æ‰§è¡Œï¼‰ |
| READY | æ¥å— | å¯ç”¨ |
| SHUTTING_DOWN | æ‹’ç» | ä»…å…³é—­æµç¨‹å¯ç”¨ |
| ERROR | æ‹’ç» | ä¸å¯ç”¨ |

---

## åŠ¨ä½œæ‰§è¡Œåˆ†å±‚è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸Šå±‚å°è£…                                  â”‚
â”‚  SafetyPose actionã€RobotCommand action ç­‰                      â”‚
â”‚  ï¼ˆå¯¹å¤–æä¾›çš„é«˜çº§æ¥å£ï¼‰                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº•å±‚æ¥å£                                  â”‚
â”‚  action/joint              service/zero_gravity                 â”‚
â”‚  (JointCommand)            (SetBool)                            â”‚
â”‚  ï¼ˆåŸºç¡€æ§åˆ¶èƒ½åŠ›ï¼‰                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ å®ç°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®ç°å±‚å¯¹è±¡                                â”‚
â”‚  MotionController          ZeroGravityManager                   â”‚
â”‚  HardwareCommander         SafePoseManager                      â”‚
â”‚  ï¼ˆå®é™…æ‰§è¡Œé€»è¾‘ï¼‰                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è°ƒç”¨è§„åˆ™

1. **ç¬¬ä¸€é˜¶æ®µå®Œæˆå**ï¼šå†…éƒ¨å¯é€šè¿‡ action/service è°ƒç”¨åº•å±‚æ¥å£
2. **ç¬¬ä¸€é˜¶æ®µå†…éƒ¨**ï¼šç›´æ¥è°ƒç”¨å®ç°å±‚å¯¹è±¡ï¼ˆaction/service å°šä¸å¯ç”¨ï¼‰
3. **ä»£ç å¤ç”¨**ï¼šä¸Šå±‚å°è£…è°ƒç”¨åº•å±‚æ¥å£ï¼Œåº•å±‚æ¥å£è°ƒç”¨å®ç°å±‚ï¼Œä¸é‡å¤å®ç°

---

## ç¬¬ä¸€é˜¶æ®µï¼ˆBaseï¼‰è¯¦è§£

### åŒæ­¥ä»»åŠ¡

åœ¨ `__init__` æ–¹æ³•ä¸­ç›´æ¥æ‰§è¡Œï¼Œä¸æ¶‰åŠ I/O é˜»å¡ã€‚

| åºå· | ä»»åŠ¡åç§° | è¯´æ˜ |
|------|----------|------|
| 1 | åˆ›å»º ROS Node | `super().__init__('robot_driver')` |
| 2 | è¯»å–å‚æ•° | ä» launch æ–‡ä»¶è¯»å–é…ç½® |
| 3 | åŠ è½½æœºå™¨äººæè¿° | åŠ è½½ URDF/XML |
| 4 | åˆ›å»º HardwareCommander | å®ä¾‹åŒ–ä½†ä¸è¿æ¥ |
| 5 | åˆ›å»º ZeroGravityManager | é›¶é‡åŠ›ç®¡ç†å™¨ |
| 6 | åˆ›å»º SafePoseManager | å®‰å…¨ä½å§¿ç®¡ç†å™¨ |
| 7 | åˆ›å»º MotionController | è¿åŠ¨æ§åˆ¶å™¨ |
| 8 | åˆ›å»º StatePublisher | çŠ¶æ€å‘å¸ƒå™¨ |
| 9 | åˆ›å»ºæœåŠ¡/Action Server | æ³¨å†Œ ROS æ¥å£ |

### å¼‚æ­¥ä»»åŠ¡

åœ¨åå°çº¿ç¨‹ä¸­é¡ºåºæ‰§è¡Œã€‚

| åºå· | ä»»åŠ¡åç§° | è¯´æ˜ | å¤±è´¥å¤„ç† |
|------|----------|------|----------|
| 1 | CAN æ¥å£å‡†å¤‡ | æ‰§è¡Œ cleanup/reset è„šæœ¬ | ERROR |
| 2 | ç¡¬ä»¶è¿æ¥ | `HardwareCommander.connect()`ï¼Œèµ‹å€¼ `_robot` | ERROR |

### å®Œæˆæ ‡å¿—

- æ—¥å¿—ï¼š`[robot_start] åŸºç¡€å¯åŠ¨å®Œæˆ`
- çŠ¶æ€ï¼šå¯è¿›å…¥ç¬¬äºŒé˜¶æ®µ

---

## ç¬¬äºŒé˜¶æ®µï¼ˆExtï¼‰è¯¦è§£

### å¼‚æ­¥ä»»åŠ¡

é€šè¿‡ action/service è°ƒç”¨æ‰§è¡Œã€‚

| åºå· | ä»»åŠ¡åç§° | è°ƒç”¨æ–¹å¼ | å¤±è´¥å¤„ç† |
|------|----------|----------|----------|
| 1 | å®‰å…¨ä½å§¿å¤ä½ | `action/joint` | ERROR |
| 2 | é›¶é‡åŠ›å¼€å¯ | `service/zero_gravity` | ERROR |

### å®Œæˆæ ‡å¿—

- æ—¥å¿—ï¼š`[robot_start] å¯åŠ¨ç»“æŸ`
- çŠ¶æ€ï¼šREADY
- shell è„šæœ¬æ‰“å°å¯åŠ¨æˆåŠŸ

---

## æ—¥å¿—è§„èŒƒ

### å¯åŠ¨é˜¶æ®µæ—¥å¿—

| æ—¶æœº | æ—¥å¿—å†…å®¹ | çº§åˆ« |
|------|----------|------|
| ç¬¬ä¸€é˜¶æ®µåŒæ­¥å¼€å§‹ | `[robot_start] èŠ‚ç‚¹åˆå§‹åŒ–ä¸­` | INFO |
| ç¬¬ä¸€é˜¶æ®µå¼‚æ­¥å¼€å§‹ | `[robot_start] å¼€å§‹ç¡¬ä»¶è¿æ¥ (attempt N)` | INFO |
| CAN å‡†å¤‡ | `[robot_start] CAN æ£€æŸ¥å¹¶æ¸…ç†ä¸­ (CAN=canX)` | INFO |
| ç¡¬ä»¶è¿æ¥æˆåŠŸ | `[robot_start] æœºæ¢°è‡‚è¿æ¥æˆåŠŸ` | INFO |
| ç¬¬ä¸€é˜¶æ®µå®Œæˆ | `[robot_start] åŸºç¡€å¯åŠ¨å®Œæˆ` | INFO |
| ç¬¬äºŒé˜¶æ®µå¼€å§‹ | `[robot_start] å¼€å§‹æ‰©å±•å¯åŠ¨` | INFO |
| å®‰å…¨ä½å§¿å¼€å§‹ | `[robot_start] å®‰å…¨ä½å§¿å¤ä½ä¸­` | INFO |
| å®‰å…¨ä½å§¿æˆåŠŸ | `[robot_start] å®‰å…¨ä½å§¿å¤ä½æˆåŠŸ` | INFO |
| é›¶é‡åŠ›å¼€å¯ | `[robot_start] é›¶é‡åŠ›æ¨¡å¼å¼€å¯` | INFO |
| ç¬¬äºŒé˜¶æ®µå®Œæˆ | `[robot_start] å¯åŠ¨ç»“æŸ` | INFO |

### é”™è¯¯æ—¥å¿—

| æ—¶æœº | æ—¥å¿—å†…å®¹ | çº§åˆ« |
|------|----------|------|
| CAN å‡†å¤‡å¤±è´¥ | `[robot_start] CAN å‡†å¤‡å¤±è´¥: {è¯¦ç»†é”™è¯¯}` | ERROR |
| ç¡¬ä»¶è¿æ¥å¤±è´¥ | `[robot_start] ç¡¬ä»¶è¿æ¥å¤±è´¥: {è¯¦ç»†é”™è¯¯}` | ERROR |
| å®‰å…¨ä½å§¿å¤±è´¥ | `[robot_start] å®‰å…¨ä½å§¿å¤ä½å¤±è´¥: {è¯¦ç»†é”™è¯¯}` | ERROR |
| é›¶é‡åŠ›å¤±è´¥ | `[robot_start] é›¶é‡åŠ›å¼€å¯å¤±è´¥: {è¯¦ç»†é”™è¯¯}` | ERROR |
| å¯åŠ¨å¤±è´¥ | `[robot_start] å¯åŠ¨å¤±è´¥ï¼Œè¿›å…¥é”™è¯¯çŠ¶æ€` | ERROR |

---

## Shell è„šæœ¬é›†æˆ

`start_robot_driver.sh` è„šæœ¬èŒè´£ï¼š

1. ç¯å¢ƒæ£€æŸ¥
2. å¯åŠ¨ `ros2 launch`
3. ç­‰å¾…æ—¥å¿—æ ‡è®°
4. æŠ¥å‘Šå¯åŠ¨çŠ¶æ€

### ç­‰å¾…çš„æ—¥å¿—æ ‡è®°

```bash
# ç­‰å¾…ç¬¬ä¸€é˜¶æ®µ
wait_for_log_marker "[robot_start] åŸºç¡€å¯åŠ¨å®Œæˆ" "åŸºç¡€å¯åŠ¨å®Œæˆ" 60

# ç­‰å¾…ç¬¬äºŒé˜¶æ®µ
wait_for_log_marker "[robot_start] å¯åŠ¨ç»“æŸ" "å¯åŠ¨ç»“æŸ" 120

# æ‰“å°å¯åŠ¨æˆåŠŸ
status_cn "robot_driver å¯åŠ¨å®Œæˆï¼ŒèŠ‚ç‚¹æ­£åœ¨è¿è¡Œ"
```

---

## å…³é—­æµç¨‹

```
shutdown æœåŠ¡è¯·æ±‚
    â†“
çŠ¶æ€ â†’ SHUTTING_DOWN
    â†“
æ‰§è¡Œ SafetyPoseï¼ˆenable_zero_gravity_after=Falseï¼‰
    â†“
æ–­å¼€ç¡¬ä»¶è¿æ¥
    â†“
æ—¥å¿—ï¼š[robot_start] å…³é—­å®Œæˆ
    â†“
é€€å‡ºèŠ‚ç‚¹
```

---

## å®ç°ä¼ªä»£ç 

```python
class AsyncTask:
    """å¼‚æ­¥ä»»åŠ¡å®šä¹‰"""
    def __init__(self, name: str, func: Callable):
        self.name = name
        self.func = func


class RobotDriverNode(Node):
    def __init__(self):
        super().__init__('robot_driver')
        self._state = RobotState.INITIALIZING
        self._logger.info('[robot_start] èŠ‚ç‚¹åˆå§‹åŒ–ä¸­')
        
        # ========== ç¬¬ä¸€é˜¶æ®µï¼šåŒæ­¥ä»»åŠ¡ ==========
        self._init_parameters()
        self._init_hardware_commander()
        self._init_managers()
        self._init_ros_interfaces()
        
        # å®šä¹‰å¼‚æ­¥ä»»åŠ¡
        self._phase1_tasks = [
            AsyncTask('CANæ¥å£å‡†å¤‡', self._task_prepare_can),
            AsyncTask('ç¡¬ä»¶è¿æ¥', self._task_connect_hardware),
        ]
        self._phase2_tasks = [
            AsyncTask('å®‰å…¨ä½å§¿å¤ä½', self._task_safe_pose),
            AsyncTask('é›¶é‡åŠ›å¼€å¯', self._task_enable_zero_gravity),
        ]
        
        # è§¦å‘å¼‚æ­¥å¯åŠ¨ï¼ˆå®šæ—¶å™¨ç¡®ä¿ executor å·²è¿è¡Œï¼‰
        self._startup_timer = self.create_timer(0.5, self._trigger_async_startup)
    
    def _trigger_async_startup(self):
        self._startup_timer.cancel()
        threading.Thread(target=self._run_startup, daemon=True).start()
    
    def _run_startup(self):
        # ========== ç¬¬ä¸€é˜¶æ®µï¼šå¼‚æ­¥ä»»åŠ¡ ==========
        self._state = RobotState.CONNECTING
        
        for task in self._phase1_tasks:
            self._logger.info(f'[robot_start] æ‰§è¡Œ: {task.name}')
            try:
                task.func()
            except Exception as e:
                self._logger.error(f'[robot_start] {task.name}å¤±è´¥: {e}')
                self._state = RobotState.ERROR
                self._logger.error('[robot_start] å¯åŠ¨å¤±è´¥ï¼Œè¿›å…¥é”™è¯¯çŠ¶æ€')
                return
        
        self._logger.info('[robot_start] åŸºç¡€å¯åŠ¨å®Œæˆ')
        
        # ========== ç¬¬äºŒé˜¶æ®µï¼šæ‰©å±•ä»»åŠ¡ ==========
        self._state = RobotState.CALIBRATING
        self._logger.info('[robot_start] å¼€å§‹æ‰©å±•å¯åŠ¨')
        
        for task in self._phase2_tasks:
            self._logger.info(f'[robot_start] æ‰§è¡Œ: {task.name}')
            try:
                task.func()
            except Exception as e:
                self._logger.error(f'[robot_start] {task.name}å¤±è´¥: {e}')
                self._state = RobotState.ERROR
                self._logger.error('[robot_start] å¯åŠ¨å¤±è´¥ï¼Œè¿›å…¥é”™è¯¯çŠ¶æ€')
                return
        
        self._state = RobotState.READY
        self._logger.info('[robot_start] å¯åŠ¨ç»“æŸ')
    
    # ========== å¤–éƒ¨è¯·æ±‚å¤„ç† ==========
    def _is_ready_for_external_request(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦å¯ä»¥æ¥å—å¤–éƒ¨è¯·æ±‚"""
        return self._state == RobotState.READY
    
    def _goal_callback(self, goal_request) -> GoalResponse:
        if not self._is_ready_for_external_request():
            self._logger.warning(f'è¯·æ±‚è¢«æ‹’ç»: å½“å‰çŠ¶æ€={self._state.value}')
            return GoalResponse.REJECT
        return GoalResponse.ACCEPT
```

---

## å®ç°ä»»åŠ¡æ‹†è§£

### ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¸…ç†æ—§ä»£ç 

| åºå· | ä»»åŠ¡ | æ–‡ä»¶ |
|------|------|------|
| 1-1 | ç§»é™¤ `wait_for_ready()` æ–¹æ³•å’Œ `_ready_condition` | `robot_driver_node.py` |
| 1-2 | ç§»é™¤ action execute ä¸­çš„ç­‰å¾…é€»è¾‘ | `robot_driver_node.py` |
| 1-3 | ç§»é™¤ `wait_for_ready` å‚æ•° | `zero_gravity_manager.py` |

### ç¬¬äºŒéƒ¨åˆ†ï¼šçŠ¶æ€ç®¡ç†é‡æ„

| åºå· | ä»»åŠ¡ | æ–‡ä»¶ |
|------|------|------|
| 2-1 | æ›´æ–° `RobotState` æšä¸¾ï¼ˆæ·»åŠ  `CALIBRATING`ï¼‰ | `robot_driver_node.py` |
| 2-2 | æ·»åŠ  `_is_ready_for_external_request()` æ–¹æ³• | `robot_driver_node.py` |
| 2-3 | ä¿®æ”¹ goal callback ä½¿ç”¨æ–°çš„çŠ¶æ€æ£€æŸ¥ | `robot_driver_node.py` |

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šä¸¤é˜¶æ®µå¯åŠ¨å®ç°

| åºå· | ä»»åŠ¡ | æ–‡ä»¶ |
|------|------|------|
| 3-1 | å®šä¹‰ `AsyncTask` ç±» | `robot_driver_node.py` |
| 3-2 | é‡æ„ `_run_async_startup()` ä¸ºä¸¤é˜¶æ®µ | `robot_driver_node.py` |
| 3-3 | å®ç°ç¬¬ä¸€é˜¶æ®µä»»åŠ¡ï¼šCANå‡†å¤‡ã€ç¡¬ä»¶è¿æ¥ | `robot_driver_node.py` |
| 3-4 | å®ç°ç¬¬äºŒé˜¶æ®µä»»åŠ¡ï¼šå®‰å…¨ä½å§¿ã€é›¶é‡åŠ› | `robot_driver_node.py` |

### ç¬¬å››éƒ¨åˆ†ï¼šæ—¥å¿—è§„èŒƒåŒ–

| åºå· | ä»»åŠ¡ | æ–‡ä»¶ |
|------|------|------|
| 4-1 | æ·»åŠ /è°ƒæ•´å¯åŠ¨é˜¶æ®µæ—¥å¿—æ ‡è®° | `robot_driver_node.py` |
| 4-2 | æ·»åŠ é”™è¯¯æ—¥å¿—è¯¦ç»†ä¿¡æ¯ | `robot_driver_node.py` |

### ç¬¬äº”éƒ¨åˆ†ï¼šShellè„šæœ¬é€‚é…

| åºå· | ä»»åŠ¡ | æ–‡ä»¶ |
|------|------|------|
| 5-1 | ä¿®æ”¹ç­‰å¾…æ–°çš„æ—¥å¿—æ ‡è®° | `start_robot_driver.sh` |

### ç¬¬å…­éƒ¨åˆ†ï¼šæµ‹è¯•éªŒè¯

| åºå· | ä»»åŠ¡ | è¯´æ˜ |
|------|------|------|
| 6-1 | ç¼–è¯‘å¹¶æµ‹è¯•å¯åŠ¨æµç¨‹ | éªŒè¯ä¸¤é˜¶æ®µå¯åŠ¨æ­£å¸¸å·¥ä½œ |

### æ¶‰åŠæ–‡ä»¶æ±‡æ€»

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `src/driver/src/driver/app/robot_driver_node.py` | ä¸»è¦é‡æ„ï¼šçŠ¶æ€ç®¡ç†ã€ä¸¤é˜¶æ®µå¯åŠ¨ |
| `src/driver/src/driver/control/zero_gravity_manager.py` | ç§»é™¤ wait_for_ready å‚æ•° |
| `src/driver/start_robot_driver.sh` | æ›´æ–°æ—¥å¿—æ ‡è®°ç­‰å¾… |

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å†…å®¹ |
|------|------|----------|
| 1.0 | 2025-11-26 | åˆå§‹ç‰ˆæœ¬ |
| 2.0 | 2025-11-26 | é‡æ„ä¸ºä¸¤é˜¶æ®µå¯åŠ¨ï¼ˆBase + Extï¼‰ |
