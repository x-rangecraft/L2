# Perception Node 配置文件

# 分割模块配置 (SAM2)
segmentation:
  config_path: "config/sam2_config.yaml"
  models_dir: "models"
  confidence_threshold: 0.5

# 点云模块配置
pointcloud:
  output_frame_id: "camera_color_optical_frame"
  min_point_count: 10
  min_depth_mm: 100
  max_depth_mm: 10000
  max_invalid_depth_ratio: 0.8
  
  # ========================================================================
  # 三项精度优化配置（推荐全部启用）
  # ========================================================================
  
  # 【优化1】深度图预处理 - 中值滤波（在反投影前减少噪声）
  depth_median_filter_enabled: true   # 启用深度图中值滤波（减少20-40%噪声点）
  depth_median_filter_size: 5         # 中值滤波核大小（3/5/7，必须是奇数，越大越平滑）
  
  # 【优化2】3D空间MAD过滤 - 统计异常值过滤（替代仅Z轴过滤）
  depth_3d_mad_filter_enabled: true   # 启用3D空间MAD过滤（同时检测X/Y/Z方向，精度提升15-30%）
  depth_3d_mad_ratio: 3.0             # 3D空间MAD倍数阈值（2.5-3.5，越小越严格）
  
  # 【优化3】加权质心计算 - 提升质心精度
  weighted_center_enabled: true       # 启用加权质心（距离加权，精度提升10-20%）
  
  # ========================================================================
  # 基础过滤配置（原有功能）
  # ========================================================================
  
  # 边缘深度过滤（解决 RealSense flying pixels 问题）
  edge_filter_enabled: true           # 总开关
  mask_erosion_pixels: 1              # Mask腐蚀像素数
  depth_gradient_filter_enabled: true  # 深度梯度过滤
  depth_gradient_threshold: 50.0      # 梯度阈值(mm)
  
  # Z轴MAD过滤（向后兼容，如果启用3D-MAD则自动禁用）
  depth_outlier_filter_enabled: true  # Z轴MAD过滤（向后兼容）
  depth_outlier_mad_ratio: 3.5        # Z轴MAD倍数阈值

# 向量化模块配置
vectorizer:
  clip:
    model: "openai/clip-vit-base-patch32"
    device: "cuda"
  dino:
    model_path: "models/dinov2_vits14.pth"
    device: "cuda"
    feature_dim: 384

# 向量索引配置
vector_index:
  index_type: "IndexFlatL2"  # 或 "IndexFlatIP"
  clip_dimension: 512
  dino_dimension: 384

# 存储配置
storage:
  data_dir: "data"  # 相对于 package 目录
  max_objects: 10000
  max_samples_per_object: 100

# 抓取模块配置
grasp:
  model_path: "models/contact_graspnet/model.pt"
  config_path: "models/contact_graspnet/config.yaml"
  max_candidates: 50
  min_confidence: 0.1  # Contact-GraspNet 输出范围约 0-0.2
  num_input_points: 20000
  z_range: [0.2, 1.0]  # 点云深度范围（米）

# 超时配置 (秒)
timeouts:
  segment: 10.0
  pointcloud: 5.0
  vectorize: 15.0
  grasp: 5.0
  total_process: 45.0
